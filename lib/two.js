!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Two=e()}(this,(function(){"use strict";const t=t=>JSON.parse(JSON.stringify(t)),e=(s,i)=>{if("[object Object]"!==Object.prototype.toString.call(s)||"[object Object]"!==Object.prototype.toString.call(i))return i;for(const o in i)if(Object.prototype.toString.call(s[o])===Object.prototype.toString.call(i[o]))switch(Object.prototype.toString.call(i[o])){case"[object Array]":JSON.stringify(i[o])!==JSON.stringify(s[o])&&(i[o]=t(s[o]));break;case"[object Object]":e(s[o],i[o]);break;case"[object Boolean]":case"[object Number]":case"[object String]":i[o]=s[o]}return i};const s=t=>t.split("-"),i=t=>t.join("-"),o={},r=()=>{let t=a();for(;o[t];)t=a();return t},a=()=>new Array(3).fill(0).map((()=>Math.ceil(255*Math.random()))).concat(255).join("-");var n,h,p,l,c={object:Object.freeze({__proto__:null,Copy:t,Assign:e}),helper:Object.freeze({__proto__:null,idToRgba:s,rgbaToId:i,createId:r})};!function(t){t.click="click",t.mousedown="mousedown",t.mousemove="mousemove",t.mouseup="mouseup",t.mouseenter="mouseenter",t.mouseleave="mouseleave"}(n||(n={}));class d{id="";name="";width=0;height=0;x=0;y=0;bgcolor="black";borderWidth=1;borderColor="black";fontSize="12px";textColor="black";text="";scaleX=1;scaleY=1;rotation=0;size=10;textList=[];textObj=[];lineHeight=0;lineWidth=0;lateX=0;lateY=0;radius=5;clientX=0;clientY=0;shapes=[];shadowColor="red";shadowBlur=0;textBaseline="bottom";opacity=1;textAlign="start"}!function(t){t.arc="Arc",t.rect="Rect",t.arrow="Arrow",t.group="Group",t.triangle="Triangle",t.pentagram="Pentagram",t.other="other"}(h||(h={}));class u{id;listeners;type;selectable=!0;props=new d;actived=!1;transformOrigin="center";constructor(t){this.type=t||h.other,this.id=r(),this.props.name=this.id,Object.defineProperty(this.props,"id",{value:this.id,enumerable:!1,configurable:!1,writable:!1}),this.listeners={}}on(t,e){this.listeners[t]?this.listeners[t].push(e):this.listeners[t]=[e]}draw(t,e){throw new Error("Method not implemented.")}transform(t){if("top_left"==this.transformOrigin)return;const{x:e,y:s,width:i,height:o,rotation:r,lateX:a,lateY:n,scaleX:h,scaleY:p}=this.props;t.translate(a,n),t.translate(e,s),t.rotate(Math.PI/180*r),t.scale(h,p),t.translate(-e,-s),t.translate(-i/2,-o/2)}initOptions(t,e){const{bgcolor:i,borderColor:o,textColor:r,borderWidth:a,shadowColor:n,shadowBlur:h,size:p,textBaseline:l,opacity:c,textAlign:d}=this.props;switch(e){case 1:t.fillStyle=r,t.fillStyle=i,t.strokeStyle=o,t.lineWidth=a,t.shadowColor=n,t.shadowBlur=h,t.font=`${p}px Arial`,t.textBaseline=l,t.textAlign=d,t.globalAlpha=c;break;case 2:const[e,u,f,m]=s(this.getRgbaId());t.fillStyle=`rgba(${e}, ${u}, ${f}, ${m})`,t.strokeStyle=`rgba(${e}, ${u}, ${f}, ${m})`,t.lineWidth=a}}drawMirror(t){const{x:e,y:s,width:i,height:o}=this.props;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,2),t.rect(e,s,i,o),t.fill(),t.stroke(),t.closePath(),t.restore()}getListeners(){return this.listeners}getRgbaId(){return this.id}setProps(t){c.object.Assign(t,this.props)}get Listeners(){return this.listeners}get Id(){return this.id}}class f extends u{constructor(t){super(),c.object.Assign(t,this.props),this.props.width=2*t.radius,this.props.height=2*t.radius}draw(t,e){const{x:s,y:i,radius:o}=this.props;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,1),t.arc(s+o,i+o,o,0,2*Math.PI,!0),t.closePath(),t.fill(),t.restore(),this.drawMirror(e)}setProps(t){super.setProps(t),this.props.width=2*t.radius,this.props.height=2*t.radius}}class m extends u{constructor(t){super(h.arrow),c.object.Assign(t,this.props)}draw(t,e){const{x:s,y:i,width:o,height:r}=this.props,a=.1*o,n=.3*r;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,1),t.moveTo(s,i+r/2),t.lineTo(s+o-a,i+r/2-n),t.lineTo(s+o-1.1*a,i),t.lineTo(s+o,i+r/2),t.lineTo(s+o-1.1*a,i+r),t.lineTo(s+o-a,i+r/2+n),t.closePath(),t.fill(),t.restore(),this.drawMirror(e)}}class y extends u{overflow;constructor(t){super(h.group),t&&c.object.Assign(t,this.props),this.overflow=t?.overflow||"show",t?.shapes&&(this.props.shapes=c.object.Copy(t?.shapes))}add(t){this.props.shapes.push(t)}remove(t){this.props.shapes.splice(this.props.shapes.findIndex((e=>e.getRgbaId()==t))||-1,1)}removeAll(){this.props.shapes.length=0}draw(t,e){const{x:s,y:i,width:o,height:r}=this.props;t.save(),e.save(),this.initOptions(t,1),this.transform(t),this.transform(e),"show"!=this.overflow&&(t.rect(s,i,o,r),t.clip(),e.rect(s,i,o,r),e.clip()),t.translate(s,i),e.translate(s,i);for(let s=0;s<this.props.shapes.length;s++){this.props.shapes[s].draw(t,e)}t.restore(),e.restore(),this.drawMirror(e)}setProps(t){super.setProps(t)}}class g extends u{constructor(t){super(h.pentagram),c.object.Assign(t,this.props),this.props.width=2*t.radius,this.props.height=2*t.radius}draw(t,e){const{x:s,y:i,radius:o}=this.props;let r,a;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,1);for(let e=0;e<5;e++)r=Math.cos((18+72*e)/180*Math.PI)*o,a=-Math.sin((18+72*e)/180*Math.PI)*o,t.lineTo(r+s+o,a+i+o),r=Math.cos((54+72*e)/180*Math.PI)*o/2,a=-Math.sin((54+72*e)/180*Math.PI)*o/2,t.lineTo(r+s+o,a+i+o);t.closePath(),t.stroke(),t.restore(),this.drawMirror(e)}setProps(t){super.setProps(t),this.props.width=2*t.radius,this.props.height=2*t.radius}}class v extends u{model;hollow;constructor(t){super(h.rect),c.object.Assign(t,this.props),this.model=t.model||"fill",this.hollow=t.hollow||!0}draw(t,e){const{x:s,y:i,width:o,height:r}=this.props;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,1),t.rect(s,i,o,r),"all"!=this.model&&"fill"!=this.model||t.fill(),"all"!=this.model&&"stroke"!=this.model||t.stroke(),t.closePath(),t.restore(),e.save(),this.transform(e),e.beginPath(),this.initOptions(e,2),e.rect(s,i,o,r),("all"==this.model||"fill"==this.model||this.hollow)&&e.fill(),"all"!=this.model&&"stroke"!=this.model||e.stroke(),e.fill(),e.stroke(),e.closePath(),e.restore()}}class b extends u{constructor(t){super(h.triangle),c.object.Assign(t,this.props)}draw(t,e){const{x:s,y:i,width:o,height:r}=this.props;t.save(),this.transform(t),t.beginPath(),this.initOptions(t,1),t.moveTo(s,i),t.lineTo(s+o,i+r),t.lineTo(s,i+r),t.closePath(),t.stroke(),t.restore(),this.drawMirror(e)}}class w{x=0;y=0}class x{scene;select=!0;selectShape=[];enable=!1;shape;mousedown;mousemove;mouseup;point={pre:new w,cur:new w};constructor(t){this.scene=t}open(){this.shape=new v({x:0,y:0,width:0,height:0,model:"all",bgcolor:"rgba(0,0,0,0.2)"}),this.shape.transformOrigin="top_left",this.shape.selectable=!1,this.scene.add(this.shape),this.mousedown=this.handleMousedown.bind(this),this.mousemove=this.handleMousemove.bind(this),this.mouseup=this.handleMouseup.bind(this),document.addEventListener("mousedown",this.mousedown),document.addEventListener("mousemove",this.mousemove),document.addEventListener("mouseup",this.mouseup)}close(){this.scene.remove(this.shape.getRgbaId()),document.removeEventListener("mousedown",this.mousedown),document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup)}handleMousedown(t){if(!this.scene.emptySpace)return;this.enable=!0,this.shape.props.x=this.point.pre.x=t.offsetX,this.shape.props.y=this.point.pre.y=t.offsetY;const e=this.scene.shapes.findIndex((t=>t.getRgbaId()==this.shape.getRgbaId()));e>-1&&(this.scene.shapes.splice(e,1),this.scene.shapes.push(this.shape))}handleMousemove(t){if(!this.enable)return;const{shape:e,point:s}=this;s.cur.x=t.offsetX,s.cur.y=t.offsetY,e.props.width=s.cur.x-s.pre.x,e.props.height=s.cur.y-s.pre.y}handleMouseup(){this.enable=!1;const{props:t}=this.shape;t.width=0,t.height=0}is_rect_cross(t,e,s,i,o,r,a,n){return Math.max(t,o)<=Math.min(s,a)&&Math.min(e,r)>=Math.max(i,n)}judgeIntersect(t,e,s,i,o,r,a,n){return Math.min(t,s)<=Math.max(o,a)&&Math.min(r,n)<=Math.max(e,i)&&Math.min(o,a)<=Math.max(t,s)&&Math.min(e,i)<=Math.max(r,n)&&(((o-t)*(i-e)-(s-t)*(r-e))*((a-t)*(i-e)-(s-t)*(n-e))<=1e-8&&((t-o)*(n-r)-(a-o)*(e-r))*((s-o)*(n-r)-(a-o)*(i-r))<=1e-8)}}class _ extends u{points;size=5;fillStyle="white";constructor(t,e,s="white"){super(),this.points=t,this.size=e,this.fillStyle=s}draw(t,e){t.save(),t.beginPath(),t.fillStyle=this.fillStyle;for(let e=0;e<this.points.length;e++){const[s,i]=this.points[e];t.moveTo(s,i),t.arc(s,i,this.size,0,2*Math.PI)}t.closePath(),t.fill(),t.restore()}}class M{size=20;scene;enable=!1;mousedownFn;mousemoveFn;mouseupFn;points=[];constructor(t){this.scene=t}open(){const{domElement:t,ctx:e,osCtx:s}=this.scene;this.mousedownFn=this.mousedown.bind(this,e,s),this.mousemoveFn=this.mousemove.bind(this,e,s),this.mouseupFn=this.mouseup.bind(this,e,s),t.addEventListener("mousedown",this.mousedownFn),t.addEventListener("mousemove",this.mousemoveFn),t.addEventListener("mouseup",this.mouseupFn)}close(){const{domElement:t}=this.scene;t.removeEventListener("mousedown",this.mousedownFn),t.removeEventListener("mousemove",this.mousemoveFn),t.removeEventListener("mouseup",this.mouseupFn)}draw(t,e,s,i){s.save(),s.beginPath(),s.arc(t,e,this.size,0,2*Math.PI),s.clip(),s.clearRect(0,0,this.scene.width,this.scene.height),s.closePath(),s.restore(),i.save(),i.beginPath(),i.arc(t,e,this.size,0,2*Math.PI),i.clip(),i.clearRect(0,0,this.scene.width,this.scene.height),i.closePath(),i.restore(),this.points.push([t,e])}mousedown=(t,e)=>{this.enable=!0};mousemove=(t,e,s)=>{this.enable&&this.draw(s.offsetX,s.offsetY,t,e)};mouseup=(t,e)=>{const{domElement:s}=this.scene,i=window.getComputedStyle(s,null).getPropertyValue("background-color");this.scene.shapes.push(new _(this.points,this.size,i)),this.scene.setHistory(),this.enable=!1}}class C extends u{pointList=[];constructor(t){super(),c.object.Assign(t,this.props),this.pointList=t.pointList,this.props.x+=this.props.width/2,this.props.y+=this.props.height/2}draw(t,e){const{width:s,height:i}=this.props;t&&e&&(t.save(),this.transform(t),t.translate(s/2,i/2),t.beginPath(),this.initOptions(t,1),this.pointList.forEach((e=>{t.lineTo(e.x,e.y)})),t.stroke(),t.closePath(),t.restore(),this.drawMirror(e))}setProps(t){super.setProps(t),this.props.x+=this.props.width/2,this.props.y+=this.props.height/2}}class S{scene;isMove=!1;addcanvasMousedown;addcanvasMousemove;addcanvasMouseup;wayList=[];size=1;color="black";shape;constructor(t){this.scene=t}open(){const{domElement:t,ctx:e}=this.scene;this.addcanvasMousedown=this.canvasMousedown.bind(this,e),this.addcanvasMousemove=this.canvasMousemove.bind(this,e),this.addcanvasMouseup=this.canvasMouseup.bind(this),t.addEventListener("mousedown",this.addcanvasMousedown),t.addEventListener("mousemove",this.addcanvasMousemove),t.addEventListener("mouseup",this.addcanvasMouseup)}canvasMousedown(t,e){this.wayList.push(),this.wayList.push({x:e.offsetX,y:e.offsetY});const s=new C({pointList:this.wayList});s.props.bgcolor=this.color,s.props.borderWidth=this.size,this.scene.add(s),this.shape=s,this.isMove=!0}canvasMousemove(t,e){this.isMove&&(this.wayList.push({x:e.offsetX,y:e.offsetY}),this.shape.pointList=this.wayList,this.scene.render())}canvasMouseup(t){this.wayList.push({x:t.offsetX,y:t.offsetY});let e=0,s=0,i=0,o=0;this.wayList.forEach(((t,r)=>{0==r&&(i=t.x,o=t.y),t.x>e&&(e=t.x),t.y>s&&(s=t.y),t.x<i&&(i=t.x),t.y<o&&(o=t.y)})),this.shape.setProps(Object.assign(new d,{id:this.shape.id,width:e-i,height:s-o,x:i,y:o})),this.wayList=[],this.scene.setHistory(),this.scene.render(),this.isMove=!1}close(){const{domElement:t}=this.scene;t.removeEventListener("mousedown",this.addcanvasMousedown),t.removeEventListener("mousemove",this.addcanvasMousemove),t.removeEventListener("mouseup",this.addcanvasMouseup)}}!function(t){t.Down="DOWN",t.Up="UP",t.Move="MOVE"}(p||(p={}));class k{listenersMap={};lastDownId="";lastMoveId="";addAction(t,e){const{type:s,id:i}=t;s===p.Move&&this.fire(i,n.mousemove,e),s!==p.Move||this.lastMoveId&&this.lastMoveId===i||(this.fire(i,n.mouseenter,e),this.fire(this.lastMoveId,n.mouseleave,e)),s===p.Down&&this.fire(i,n.mousedown,e),s===p.Up&&this.fire(i,n.mouseup,e),s===p.Up&&this.lastDownId===i&&this.fire(i,n.click,e),s===p.Move?this.lastMoveId=t.id:s===p.Down&&(this.lastDownId=t.id)}addListeners(t,e){this.listenersMap[t]=e}fire(t,e,s){this.listenersMap[t]&&this.listenersMap[t][e]&&this.listenersMap[t][e].forEach((e=>e(s,t)))}}!function(t){t.line="line",t.base="base",t.top="top",t.right="right",t.bottom="bottom",t.left="left",t.scale="scale",t.topL="topL",t.topR="topR",t.bottomL="bottomL",t.bottomR="bottomR"}(l||(l={}));const I=[l.line,l.base,l.top,l.right,l.bottom,l.left,l.scale,l.topL,l.topR,l.bottomL,l.bottomR];class P extends u{shapeMap=new Map;WIDTH=15;HEIGHT=15;borderColor="rgba(71, 154, 227, 1)";constructor(t){super(),c.object.Assign(t,this.props),I.forEach((t=>{this.shapeMap.set((new u).getRgbaId(),t)})),this.selectable=!1}handlePoints(){const{x:t,y:e,width:s}=this.props;return[{x:t+s/2,y:e-this.HEIGHT/2},{x:t+s/2,y:e-2*this.HEIGHT+this.HEIGHT/2}]}handleProps(t){const{x:e,y:s,width:i,height:o}=this.props;let r=0,a=0,n=this.WIDTH,h=this.HEIGHT;switch(t){case l.base:r=e,a=s,n=i,h=o;break;case l.top:r=e,a=s-o/2;break;case l.bottom:r=e,a=s+o/2;break;case l.left:r=e-i/2,a=s;break;case l.right:r=e+i/2,a=s;break;case l.topL:r=e-i/2,a=s-o/2;break;case l.topR:r=e+i/2,a=s-o/2;break;case l.bottomL:r=e-i/2,a=s+o/2;break;case l.bottomR:r=e+i/2,a=s+o/2;break;case l.scale:r=e,a=s-o/2-2*h}return{x:t==l.base?r:r+i/2-n/2,y:t==l.base?a:a+o/2-h/2,width:n,height:h}}draw(t,e){t.save(),this.transform(t),this.initOptions(t,1),this.shapeMap.forEach(((e,s)=>{if(t.beginPath(),e==l.line){const e=this.handlePoints();t.lineTo(e[0].x,e[0].y),t.lineTo(e[1].x,e[1].y)}else{const{x:s,y:i,width:o,height:r}=this.handleProps(e);t.rect(s,i,o,r)}t.stroke(),t.closePath()})),t.restore(),e.save(),this.transform(e),e.beginPath(),this.shapeMap.forEach(((t,i)=>{const[o,r,a,n]=s(i);if(e.fillStyle=`rgba(${o}, ${r}, ${a}, ${n})`,e.strokeStyle=`rgba(${o}, ${r}, ${a}, ${n})`,e.beginPath(),t==l.line){const t=this.handlePoints();e.lineTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y)}else{const{x:s,y:i,width:o,height:r}=this.handleProps(t);e.rect(s,i,o,r)}t==l.line||t==l.base?e.stroke():e.fill(),e.closePath()})),e.restore()}setProps(t){super.setProps(t),this.props.borderColor=this.borderColor,this.props.width*=this.props.scaleX,this.props.height*=this.props.scaleY,this.props.scaleX=1,this.props.scaleY=1}}class E{x=0;y=0}class T{state=0;scene;enable=!1;type="shape";activedId="";shape;activeShape;point={pre:new E,cur:new E,tl:new E,tr:new E,bl:new E,br:new E};mousemove;mouseup;constructor(t){this.scene=t}open(){this.state=1,this.shape=new P({x:0,y:0,widht:0,height:0}),this.scene.shapes.push(this.shape),this.scene.eventSimulator.addListeners(this.shape.getRgbaId(),this.shape.getListeners()),this.shape.shapeMap.forEach(((t,e)=>{this.scene.IDS.add(e)})),this.mousemove=this.handleMousemove.bind(this),this.mouseup=this.handleMouseup.bind(this),document.addEventListener("mousemove",this.mousemove),document.addEventListener("mouseup",this.mouseup)}close(){this.state=0,this.scene.remove(this.shape.getRgbaId()),this.shape.shapeMap.forEach(((t,e)=>{this.scene.IDS.has(e)&&this.scene.IDS.delete(e)})),this.activeShape&&this.scene.remove(this.shape.getRgbaId()),this.activeShape=null,this.scene.activeShape=null,document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup)}handleMousemove(t){if(!this.enable)return;const{activeShape:e,shape:s,type:i,point:o}=this;o.cur.x=t.offsetX,o.cur.y=t.offsetY;const r=o.cur.x-o.pre.x,a=o.cur.y-o.pre.y;if(e){switch(i){case"shape":e.props.lateX+=r,e.props.lateY+=a,s.props.lateX+=r,s.props.lateY+=a,s.props.borderColor="rgba(71, 154, 227, 0.5)";break;case"frame":const t=1+(s.props.width-e.props.width)/e.props.width||1,i=1+(s.props.height-e.props.height)/e.props.height||1,n=(t=!0,i=!0)=>{const n=s.props.rotation*Math.PI/180;let h=0,p=0;if(t&&!i)h=r/2*Math.cos(n),p=r/2*Math.sin(n);else if(!t&&i)h=a/2*Math.sin(-n),p=a/2*Math.cos(-n);else if(t&&i){const{width:t,height:e}=s.props;let i,r,a;switch(i=r=a="tl",s.shapeMap.get(this.activedId)){case l.topL:i="br",r="bl",a="tr";break;case l.topR:i="bl",r="tl",a="br";break;case l.bottomL:i="tr",r="tl",a="br";break;case l.bottomR:i="tl",r="bl",a="tr"}const n=o[a].x-o[i].x,c=o[a].y-o[i].y,d=o[r].x-o[i].x,u=o[r].y-o[i].y,f=180*Math.atan2(c,n)/Math.PI,m=180*Math.atan2(u,d)/Math.PI,y=o[i].x+t*Math.cos(f*Math.PI/180),g=o[i].y+t*Math.sin(f*Math.PI/180),v=o[i].x+e*Math.cos(m*Math.PI/180),b=o[i].y+e*Math.sin(m*Math.PI/180);return h=v+(y-v)/2,void(p=b+(g-b)/2)}s.props.lateX+=h,s.props.lateY+=p,e.props.lateX+=h,e.props.lateY+=p};switch(s.shapeMap.get(this.activedId)){case l.left:s.props.width-=r,e.props.scaleX=t,n(!0,!1);break;case l.right:s.props.width+=r,e.props.scaleX=t,n(!0,!1);break;case l.top:s.props.height-=a,e.props.scaleY=i,n(!1,!0);break;case l.bottom:s.props.height+=a,e.props.scaleY=i,n(!1,!0);break;case l.topL:s.props.width-=r,s.props.height-=a,e.props.scaleX=t,e.props.scaleY=i,n(!0,!0);break;case l.topR:s.props.width+=r,s.props.height-=a,e.props.scaleX=t,e.props.scaleY=i,n(!0,!0);break;case l.bottomL:s.props.width-=r,s.props.height+=a,e.props.scaleX=t,e.props.scaleY=i,n(!0,!0);break;case l.bottomR:s.props.width+=r,s.props.height+=a,e.props.scaleX=t,e.props.scaleY=i,n(!0,!0);break;case l.scale:const h=o.cur.x-(s.props.x+s.props.lateX),p=o.cur.y-(s.props.y+s.props.lateY),c=180*Math.atan2(p,h)/Math.PI+90;s.props.rotation=c,e.props.rotation=c}}this.scene.render()}o.pre.x=t.offsetX,o.pre.y=t.offsetY}handleMouseup(){this.enable&&"shape"==this.type&&(this.shape.props.borderColor="rgba(71, 154, 227, 1)",document.body.style.cursor="default",this.scene.render()),this.enable=!1}handleFrameBox(t,e,s){if(0==this.state||t!=p.Down)return;const{shapes:i}=this.scene,{shape:o,point:r}=this;if(o.shapeMap.get(e)){this.type="frame",this.activedId=e,r.pre.x=s.offsetX,r.pre.y=s.offsetY;const t=t=>{const{x:e,y:s,width:i,height:r,rotation:a}=o.props,n=Math.sqrt(i*i+r*r)/2;return{x:e+n*Math.cos((a+t)*Math.PI/180),y:s+n*Math.sin((a+t)*Math.PI/180)}};r.tl=t(-135),r.tr=t(-45),r.bl=t(135),r.br=t(45),this.enable=!0}else this.scene.emptySpace?o&&(this.scene.remove(o.getRgbaId()),this.activeShape=null,this.scene.activeShape=null):(this.activeShape=null,this.scene.activeShape=null,i.forEach((t=>{t.actived=!1,t.getRgbaId()==e&&(this.type="shape",t.actived=!0,this.activeShape=t,this.scene.activeShape=t,this.shape.setProps(this.activeShape.props),this.scene.shapes.push(this.shape),document.body.style.cursor="move",r.pre.x=s.offsetX,r.pre.y=s.offsetY,this.enable=!0)})));const a=this.scene.historyID.indexOf(o.getRgbaId());this.activeShape?(this.shape.setProps(this.activeShape.props),-1==a&&this.scene.historyID.push(o.getRgbaId())):-1!=a&&this.scene.historyID.splice(a,1),this.scene.render()}}class L{canvas;osCanvas;ctx;osCtx;dpr;width=300;height=250;eventSimulator;IDS;historyID=[];shapes;group=[];shapesEvent;emptySpace=!1;activeShape;constructor(t,e){if(!(t&&t instanceof Element))throw new Error('The incoming type is incorrect, please pass in the "Element" type');e&&(this.width=e.width||300,this.height=e.height||250),this.canvas=t,this.osCanvas=new OffscreenCanvas(this.canvas.width,this.canvas.height),this.canvas.width=this.width,this.canvas.height=this.height,this.osCanvas.width=this.width,this.osCanvas.height=this.height,this.ctx=this.canvas.getContext("2d"),this.osCtx=this.osCanvas.getContext("2d"),this.ctx?.scale(1,1),this.osCtx?.scale(1,1),this.dpr=1,this.canvas.addEventListener("mousedown",this.handleCreator(p.Down)),this.canvas.addEventListener("mouseup",this.handleCreator(p.Up)),this.canvas.addEventListener("mousemove",this.handleCreator(p.Move)),this.eventSimulator=new k,this.shapes=new Array,this.IDS=new Set,this.shapesEvent=new T(this),this.shapesEvent.open()}handleCreator=t=>e=>{const s=e.offsetX,i=e.offsetY,o=this.hitJudge(s,i);if(this.eventSimulator.addAction({type:t,id:o},e),t==p.Down&&this.osCtx){const t=Array.from(this.osCtx.getImageData(s*this.dpr,i*this.dpr,1,1).data);this.emptySpace=t.every((t=>0==t))}this.shapesEvent.handleFrameBox(t,o,e)};hitJudge(t,e){if(!this.osCtx)return"";const s=Array.from(this.osCtx.getImageData(t*this.dpr,e*this.dpr,1,1).data),o=i(s);return this.IDS.has(o)?o:""}add(t){this.shapes.push(t),this.eventSimulator.addListeners(t.getRgbaId(),t.getListeners()),this.IDS.add(t.getRgbaId()),this.historyID.push(t.getRgbaId()),t.type==h.group&&this.group.push(t)}remove(t){const e=this.shapes.findIndex((e=>e.getRgbaId()==t));if(-1==e)return;this.shapes.splice(e,1),this.IDS.has(t)&&this.IDS.delete(t);const s=this.group.findIndex((e=>e.getRgbaId()==t));-1!=s&&this.group.splice(s,1)}render(){if(!this.ctx||!this.osCtx)throw new Error("渲染失败");this.clearCanvas();for(let t=0;t<this.shapes.length;t++)-1!=this.historyID.indexOf(this.shapes[t].getRgbaId())&&this.shapes[t].draw(this.ctx,this.osCtx)}clearCanvas(){this.ctx.clearRect(0,0,this.width,this.height),this.osCtx.clearRect(0,0,this.width,this.height)}updateCanvasInfo(){this.canvas.width=this.width,this.canvas.height=this.height,this.osCanvas.width=this.width,this.osCanvas.height=this.height}get domElement(){return this.canvas}}class O extends u{constructor(t){super(),c.object.Assign(t,this.props)}draw(t,e){const{x:s,y:i,size:o,width:r,height:a,lineHeight:n,textObj:h}=this.props;t&&e&&(t.save(),this.transform(t),t.translate(r/2,a/2),t.beginPath(),this.initOptions(t,1),h.forEach(((e,r)=>{e.forEach((e=>{"select"==e.type?(t.fillStyle="blue",t.fillRect(s+e.len*o,i+(r+1)*n-n,o*e.text.length,n+5),t.fillStyle="white",t.fillText(e.text,s+e.len*o,i+(r+1)*n)):(t.fillStyle="black",t.fillText(e.text,s+e.len*o,i+(r+1)*n))}))})),t.closePath(),t.stroke(),t.restore(),this.drawMirror(e))}setProps(t){super.setProps(t)}}class A{props;scene;cursor;textarea;addcanvasMouseUp;addKeyUp;addKeyDown;textContent;textContentList=[];timeout;moveKey=["ArrowRight","ArrowLeft","ArrowUp","ArrowDown","Home","End"];constructor(t){this.scene=t}open(){const{domElement:t}=this.scene;this.addcanvasMouseUp=this.canvasMousedown.bind(this),this.addKeyUp=this.keyUp.bind(this),this.addKeyDown=this.keyDown.bind(this),t.addEventListener("mouseup",this.addcanvasMouseUp),this.createCss()}canvasMousedown(t){this.props=this.initProps(t),this.textContent=new O(this.props),this.textContentList.push(this.textContent),this.scene.add(this.textContent),this.createAuxiliary(),this.textarea?.focus(),this.setLineHeight("行高")}close(){const{domElement:t}=this.scene;t.removeEventListener("mouseup",this.addcanvasMouseUp),this.removeCursor(this.cursor),this.removeTextarea(this.textarea)}createAuxiliary(){const{props:t,cursor:e,textarea:s,createCursor:i,createTextarea:o,updateTextareaPosition:r}=this;e&&s?(this.updateCursorPosition(),r(s,t),s.value=""):(this.cursor=i(t),this.textarea=o.bind(this)(t),this.textarea.addEventListener("keyup",this.addKeyUp),this.textarea.addEventListener("keydown",this.addKeyDown))}createCursor(t){const{clientX:e,clientY:s,size:i}=t;let o=document.createElement("DIV");return o.style.position="absolute",o.style.left=e+"px",o.style.top=s+"px",o.style.width="1px",o.style.height=i+2+"px",o.style.backgroundColor="black",o.className="cursor",document.body.appendChild(o),o}createTextarea(t){const{clientX:e,clientY:s}=t;let i=document.createElement("textarea");return i.setAttribute("id","myTextarea"),i.style.cssText=`\n        position:absolute;\n        width:200px;height:100px;\n        left:${e}px;\n        top:${s+50}px;\n        opacity:0`,document.body.appendChild(i),i.addEventListener("input",(t=>{this.fillterText(t.target.value)})),i}fillterText(t){if(!t)return[];this.props.textObj=t.split("\n").map((t=>[{type:"text",text:t,len:0}]))}updateCursorPosition(){const{cursor:t,props:e}=this,{x:s,y:i}=this.getCaretPosition(this.textarea);t&&(t.className="",t.style.left=e.clientX+s+"px",t.style.top=e.clientY+i+"px",this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((()=>{t.className="cursor"}),500))}updateTextareaPosition(t,e){const{clientX:s,clientY:i}=e;t.style.left=s+"px",t.style.top=i+50+"px"}keyDown(t){const{target:e,shiftKey:s,key:i}=t;this.moveKey.includes(i)?this.updateCursorPosition():e&&this.updateText(e.value||null)}keyUp(t){const{target:e,key:s}=t;this.moveKey.includes(s)?this.updateCursorPosition():this.updateText(e.value||null)}removeCursor(t){t&&document.body.removeChild(t),this.cursor=void 0}removeTextarea(t){t&&document.body.removeChild(t),this.textarea=void 0}getCaretPosition(t){if(!t)return!1;let e=0,s=1,i=1;(t.selectionStart||0===t.selectionStart)&&(e=t.selectionStart);let o=t.value.slice(0,e).split("\n");this.updateWidthAndHeight(o),s=o.length-1,i=o[s].length;let r=this.getTextWidth(o[s].slice(0,i)),a=s*this.props.lineHeight;if(t.selectionStart!=t.selectionEnd){const e=(t.value.slice(0,t.selectionStart)+"<select>"+t.value.slice(t.selectionStart,t.selectionEnd)+"</select>"+t.value.slice(t.selectionEnd)).split("\n");let s=!1;this.props.textObj=e.map((t=>{const e=t.match("<select>"),i=t.match("</select>"),o=[];if(e&&(s=!0),e&&i){const e=t.split("<select>");e[0].length&&o.push({type:"text",text:e[0]});const i=t.match(/\<select\>(\S*)\<\/select\>/);i&&o.push({type:"select",text:i[1]});const r=t.split("</select>");r[1].length&&o.push({type:"text",text:r[1]}),s=!1}else if(s)if(e){const e=t.split("<select>");e[0]&&o.push({type:"text",text:e[0]}),e[1]&&o.push({type:"select",text:e[1]})}else if(i){const e=t.split("</select>");e[0]&&o.push({type:"select",text:e[0]}),e[1]&&o.push({type:"text",text:e[1]}),s=!1}else o.push({type:"select",text:t});else o.push({type:"text",text:t});let r=0;return o.forEach((t=>{t.len=r,r+=t.text.length})),o})),this.textContent.setProps(this.props)}else this.fillterText(t.value),this.textContent.setProps(this.props);return{x:r,y:a}}updateText(t){const{text:e}=this.props;t!=e&&(this.props.text=t,this.textContent.setProps(this.props),this.updateCursorPosition(),this.scene.render())}getTextWidth(t){const{ctx:e}=this.scene,{size:s}=this.props;return e?(e.font=`${s}px Arial`,e.measureText(t).width):0}setLineHeight(t){const{ctx:e}=this.scene,{size:s}=this.props;e.font=`${s}px Arial`;let i=e.measureText(t);this.props.lineHeight=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent}createCss(){var t=document.createElement("style");t.innerHTML="\n                    .cursor{\n                        opacity:1;\n                        animation: flicker .8s infinite;\n                    }\n                    @keyframes flicker{\n                        50%{\n                            opacity:0\n                        }\n                    }\n                    ",document.head.appendChild(t)}updateWidthAndHeight(t){let e={text:"",length:0};const{lineHeight:s}=this.props;t&&(t.map((t=>{t.length>e.text.length&&(e.text=t)})),this.props.width=this.getTextWidth(e.text),this.props.height=s*t.length)}initProps(t){const{domElement:e}=this.scene;let s=new d;return s.id=String(Date.now()),s.x=t.offsetX,s.y=t.offsetY,s.clientX=t.offsetX+e.offsetLeft,s.clientY=t.offsetY+e.offsetTop,s}}class R{steps=0;steps_run=0;history=[];setHistory(t,e){const s=t?1:-1;this.steps+=s,this.steps_run+=s,t&&e?this.history.push(e):this.history.pop()}back(){this.steps_run>0&&this.steps_run--}go(){this.steps_run<this.steps&&this.steps_run++}push(t){if(!t)throw new Error("请传入数据");this.setHistory(1,t)}pop(){this.setHistory(0)}getCurrent(){return 0==this.steps_run?null:this.history[this.steps_run-1]}clear(){this.steps=0,this.steps_run=0,this.history.length=0}getSteps(){return this.steps}getCurSteps(){return this.steps_run}}class D extends L{history=new R;model="normal";erase;pen;textarea;boxSelect;scale=1;ratio=.5;offsetx=0;offsety=0;rollerEventfn;constructor(t,e){if(!(t&&t instanceof Element))throw new Error('The incoming type is incorrect, please pass in the "Element" type');super(t,e),this.erase=new M(this),this.pen=new S(this),this.textarea=new A(this),this.boxSelect=new x(this),this.rollerEventfn=this.rollerEvent.bind(this),this.initRollerEvent(),this.boxSelect.open(),this.animate(),this.closeRollerEvent()}import(t){this.width=t.width,this.height=t.height,this.updateCanvasInfo();const e=(t,s)=>{t.forEach((t=>{switch(t.type){case h.arc:s.add(new f(t.props));break;case h.arrow:s.add(new m(t.props));break;case h.pentagram:s.add(new g(t.props));break;case h.rect:s.add(new v(t.props));break;case h.triangle:s.add(new b(t.props));break;case h.group:const i=new y(t.props);i.removeAll(),s.add(i),e(t.props.shapes,i)}}))};e(t.shapes,this),this.setHistory(),this.render()}export(){const t={width:this.width,height:this.height,shapes:this.shapes.map((t=>({type:t.type,props:t.props})))};return JSON.stringify(t)}animate(){this.render(),window.requestAnimationFrame(this.animate.bind(this))}setModel(t){switch(this.model=t,t){case"erase":this.erase.open(),this.pen.close(),this.shapesEvent.close(),this.textarea.close(),this.boxSelect.close();break;case"pen":this.pen.open(),this.erase.close(),this.shapesEvent.close(),this.textarea.close(),this.boxSelect.close();break;case"textarea":this.textarea.open(),this.pen.close(),this.erase.close(),this.shapesEvent.close(),this.boxSelect.close();break;case"normal":this.shapesEvent.open(),this.boxSelect.open(),this.erase.close(),this.pen.close(),this.textarea.close()}}setHistory(){const t=this.shapes.map((t=>c.object.Copy(t.props)));this.history.push({name:"shapes",data:t})}setShapes(){this.shapes.forEach((t=>{this.history.getCurrent()?.data.forEach((e=>{t.getRgbaId()==e.id&&t.setProps(e)}))})),this.historyID=this.history.getCurrent()?.data.map((t=>t.id||t.name))||[]}revokeCanvas(){this.history.back(),this.setShapes(),this.render()}recoverCanvas(){this.history.go(),this.setShapes(),this.render()}resetCanvas(){this.history.clear(),this.clearCanvas()}amplify(t,e,s,i){if(this.scale>=5)return;const o=this.domElement,{width:r,height:a}=this;t&&e||(t=r/2,e=a/2),this.scale+=this.ratio,o.style.transform=`scale(${this.scale})`,o.style.transformOrigin=`${t}px ${e}px`,s&&i&&(o.style.position="absolute",o.style.top=`${i}px`,o.style.left=`${s}px`)}reduce(t,e,s,i){if(this.scale<=.2)return;const o=this.domElement,{width:r,height:a}=this;t&&e||(t=r/2,e=a/2),this.scale=this.scale-this.ratio<.2?.2:this.scale-this.ratio,o.style.transform=`scale(${this.scale})`,o.style.transformOrigin=`${t}px ${e}px`,s&&i&&(o.style.position="absolute",o.style.top=`${i}px`,o.style.left=`${s}px`)}moveCanvas(t,e){const s=this.domElement;switch(t){case"top":this.offsety-=e;break;case"bottom":this.offsety+=e;break;case"left":this.offsetx-=e;break;case"right":this.offsetx+=e}s.style.transform=`translate(${this.offsetx}px,${this.offsety}px)`}initRollerEvent(){this.domElement.addEventListener("wheel",this.rollerEventfn)}rollerEvent(t){t.preventDefault();let e=t.clientX-t.offsetX,s=t.clientY-t.offsetY;t.deltaY<0?this.amplify(t.offsetX,t.offsetY,e,s):this.reduce(t.offsetX,t.offsetY,e,s)}closeRollerEvent(){this.domElement.removeEventListener("wheel",this.rollerEventfn)}Rect(t){const e=new v(t);return this.add(e),this.render(),this.setHistory(),e}Triangle(t){const e=new b(t);return this.add(e),this.render(),this.setHistory(),e}Arrow(t){const e=new m(t);return this.add(e),this.render(),this.setHistory(),e}Arc(t){const e=new f(t);return this.add(e),this.render(),this.setHistory(),e}Pentagram(t){const e=new g(t);return this.add(e),this.render(),this.setHistory(),e}Group(t){const e=new y(t);return this.add(e),this.render(),e}setCanvasCursor(t){this.domElement.style.cursor=`url('../${t}'),auto`}}var j,X=Object.freeze({Linear:Object.freeze({None:function(t){return t},In:function(t){return this.None(t)},Out:function(t){return this.None(t)},InOut:function(t){return this.None(t)}}),Quadratic:Object.freeze({In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}),Cubic:Object.freeze({In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}}),Quartic:Object.freeze({In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}}),Quintic:Object.freeze({In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}}),Sinusoidal:Object.freeze({In:function(t){return 1-Math.sin((1-t)*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.sin(Math.PI*(.5-t)))}}),Exponential:Object.freeze({In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}}),Circular:Object.freeze({In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}}),Elastic:Object.freeze({In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(t){var e=1.70158;return 1===t?1:t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return 0===t?0:--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}}),Bounce:Object.freeze({In:function(t){return 1-X.Bounce.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return t<.5?.5*X.Bounce.In(2*t):.5*X.Bounce.Out(2*t-1)+.5}}),generatePow:function(t){return void 0===t&&(t=4),t=(t=t<Number.EPSILON?Number.EPSILON:t)>1e4?1e4:t,{In:function(e){return Math.pow(e,t)},Out:function(e){return 1-Math.pow(1-e,t)},InOut:function(e){return e<.5?Math.pow(2*e,t)/2:(1-Math.pow(2-2*e,t))/2+.5}}}}),Y=function(){return performance.now()},z=function(){function t(){this._tweens={},this._tweensAddedDuringUpdate={}}return t.prototype.getAll=function(){var t=this;return Object.keys(this._tweens).map((function(e){return t._tweens[e]}))},t.prototype.removeAll=function(){this._tweens={}},t.prototype.add=function(t){this._tweens[t.getId()]=t,this._tweensAddedDuringUpdate[t.getId()]=t},t.prototype.remove=function(t){delete this._tweens[t.getId()],delete this._tweensAddedDuringUpdate[t.getId()]},t.prototype.update=function(t,e){void 0===t&&(t=Y()),void 0===e&&(e=!1);var s=Object.keys(this._tweens);if(0===s.length)return!1;for(;s.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<s.length;i++){var o=this._tweens[s[i]],r=!e;o&&!1===o.update(t,r)&&!e&&delete this._tweens[s[i]]}s=Object.keys(this._tweensAddedDuringUpdate)}return!0},t}(),H={Linear:function(t,e){var s=t.length-1,i=s*e,o=Math.floor(i),r=H.Utils.Linear;return e<0?r(t[0],t[1],i):e>1?r(t[s],t[s-1],s-i):r(t[o],t[o+1>s?s:o+1],i-o)},Bezier:function(t,e){for(var s=0,i=t.length-1,o=Math.pow,r=H.Utils.Bernstein,a=0;a<=i;a++)s+=o(1-e,i-a)*o(e,a)*t[a]*r(i,a);return s},CatmullRom:function(t,e){var s=t.length-1,i=s*e,o=Math.floor(i),r=H.Utils.CatmullRom;return t[0]===t[s]?(e<0&&(o=Math.floor(i=s*(1+e))),r(t[(o-1+s)%s],t[o],t[(o+1)%s],t[(o+2)%s],i-o)):e<0?t[0]-(r(t[0],t[0],t[1],t[1],-i)-t[0]):e>1?t[s]-(r(t[s],t[s],t[s-1],t[s-1],i-s)-t[s]):r(t[o?o-1:0],t[o],t[s<o+1?s:o+1],t[s<o+2?s:o+2],i-o)},Utils:{Linear:function(t,e,s){return(e-t)*s+t},Bernstein:function(t,e){var s=H.Utils.Factorial;return s(t)/s(e)/s(t-e)},Factorial:(j=[1],function(t){var e=1;if(j[t])return j[t];for(var s=t;s>1;s--)e*=s;return j[t]=e,e}),CatmullRom:function(t,e,s,i,o){var r=.5*(s-t),a=.5*(i-e),n=o*o;return(2*e-2*s+r+a)*(o*n)+(-3*e+3*s-2*r-a)*n+r*o+e}}},U=function(){function t(){}return t.nextId=function(){return t._nextId++},t._nextId=0,t}(),F=new z,W=function(){function t(t,e){void 0===e&&(e=F),this._object=t,this._group=e,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=X.Linear.None,this._interpolationFunction=H.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=U.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return t.prototype.getId=function(){return this._id},t.prototype.isPlaying=function(){return this._isPlaying},t.prototype.isPaused=function(){return this._isPaused},t.prototype.to=function(t,e){if(void 0===e&&(e=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=t,this._propertiesAreSetUp=!1,this._duration=e,this},t.prototype.duration=function(t){return void 0===t&&(t=1e3),this._duration=t,this},t.prototype.dynamic=function(t){return void 0===t&&(t=!1),this._isDynamic=t,this},t.prototype.start=function(t,e){if(void 0===t&&(t=Y()),void 0===e&&(e=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var s in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=t,this._startTime+=this._delayTime,!this._propertiesAreSetUp||e){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var o in this._valuesEnd)i[o]=this._valuesEnd[o];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,e)}return this},t.prototype.startFromCurrentValues=function(t){return this.start(t,!0)},t.prototype._setupProperties=function(t,e,s,i,o){for(var r in s){var a=t[r],n=Array.isArray(a),h=n?"array":typeof a,p=!n&&Array.isArray(s[r]);if("undefined"!==h&&"function"!==h){if(p){if(0===(y=s[r]).length)continue;for(var l=[a],c=0,d=y.length;c<d;c+=1){var u=this._handleRelativeValue(a,y[c]);if(isNaN(u)){p=!1;break}l.push(u)}p&&(s[r]=l)}if("object"!==h&&!n||!a||p)(void 0===e[r]||o)&&(e[r]=a),n||(e[r]*=1),i[r]=p?s[r].slice().reverse():e[r]||0;else{e[r]=n?[]:{};var f=a;for(var m in f)e[r][m]=f[m];i[r]=n?[]:{};var y=s[r];if(!this._isDynamic){var g={};for(var m in y)g[m]=y[m];s[r]=y=g}this._setupProperties(f,e[r],y,i[r],o)}}}},t.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},t.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},t.prototype.pause=function(t){return void 0===t&&(t=Y()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=t,this._group&&this._group.remove(this)),this},t.prototype.resume=function(t){return void 0===t&&(t=Y()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=t-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},t.prototype.stopChainedTweens=function(){for(var t=0,e=this._chainedTweens.length;t<e;t++)this._chainedTweens[t].stop();return this},t.prototype.group=function(t){return void 0===t&&(t=F),this._group=t,this},t.prototype.delay=function(t){return void 0===t&&(t=0),this._delayTime=t,this},t.prototype.repeat=function(t){return void 0===t&&(t=0),this._initialRepeat=t,this._repeat=t,this},t.prototype.repeatDelay=function(t){return this._repeatDelayTime=t,this},t.prototype.yoyo=function(t){return void 0===t&&(t=!1),this._yoyo=t,this},t.prototype.easing=function(t){return void 0===t&&(t=X.Linear.None),this._easingFunction=t,this},t.prototype.interpolation=function(t){return void 0===t&&(t=H.Linear),this._interpolationFunction=t,this},t.prototype.chain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this._chainedTweens=t,this},t.prototype.onStart=function(t){return this._onStartCallback=t,this},t.prototype.onEveryStart=function(t){return this._onEveryStartCallback=t,this},t.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},t.prototype.onRepeat=function(t){return this._onRepeatCallback=t,this},t.prototype.onComplete=function(t){return this._onCompleteCallback=t,this},t.prototype.onStop=function(t){return this._onStopCallback=t,this},t.prototype.update=function(t,e){if(void 0===t&&(t=Y()),void 0===e&&(e=!0),this._isPaused)return!0;var s,i,o=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(t>o)return!1;e&&this.start(t,!0)}if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0),i=(t-this._startTime)/this._duration,i=0===this._duration||i>1?1:i;var r=this._easingFunction(i);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,r),this._onUpdateCallback&&this._onUpdateCallback(this._object,i),1===i){if(this._repeat>0){for(s in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[s]||(this._valuesStartRepeat[s]=this._valuesStartRepeat[s]+parseFloat(this._valuesEnd[s])),this._yoyo&&this._swapEndStartRepeatValues(s),this._valuesStart[s]=this._valuesStartRepeat[s];return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=t+this._repeatDelayTime:this._startTime=t+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var a=0,n=this._chainedTweens.length;a<n;a++)this._chainedTweens[a].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},t.prototype._updateProperties=function(t,e,s,i){for(var o in s)if(void 0!==e[o]){var r=e[o]||0,a=s[o],n=Array.isArray(t[o]),h=Array.isArray(a);!n&&h?t[o]=this._interpolationFunction(a,i):"object"==typeof a&&a?this._updateProperties(t[o],r,a,i):"number"==typeof(a=this._handleRelativeValue(r,a))&&(t[o]=r+(a-r)*i)}},t.prototype._handleRelativeValue=function(t,e){return"string"!=typeof e?e:"+"===e.charAt(0)||"-"===e.charAt(0)?t+parseFloat(e):parseFloat(e)},t.prototype._swapEndStartRepeatValues=function(t){var e=this._valuesStartRepeat[t],s=this._valuesEnd[t];this._valuesStartRepeat[t]="string"==typeof s?this._valuesStartRepeat[t]+parseFloat(s):this._valuesEnd[t],this._valuesEnd[t]=e},t}(),$=U.nextId,B=F,N=B.getAll.bind(B),G=B.removeAll.bind(B),q=B.add.bind(B),V=B.remove.bind(B),K=B.update.bind(B),J={Easing:X,Group:z,Interpolation:H,now:Y,Sequence:U,nextId:$,Tween:W,VERSION:"21.0.0",getAll:N,removeAll:G,add:q,remove:V,update:K};class Q extends D{animateType="";count=0;animateClip=[];constructor(t,e){super(t,e),this.onMounted(this),setTimeout((()=>{this.addAnimateGroup(),this.animateClip[0].addAnimate({shape:this.shapes.find((t=>"Group"==t.type)),property:"x",to:0,duration:3e3}),this.animateClip[0].start()}),2e3)}taskQueue(){}addAnimateGroup(){this.animateClip.push(new Z)}onMounted(t){}onBeforeUnMounted(t){}onUnMounted(t){}snapshot(t,e){const s=new Image;t.clearRect(0,0,800,500);for(let e=0;e<this.shapes.length;e++)this.shapes[e].draw(t,this.osCtx);return t.beginPath(),t.font="30px Arial",t.fillText("妙手空空"+this.count,300,480),t.closePath(),t.stroke(),s.src=e.toDataURL(),s}}class Z{id=Date.now();name="";action=[];isInitialize=!1;state=0;constructor(t){this.name=t||Date.now()+""}addAnimate(t){if(!t.property||!t.shape)throw new Error("property or shape type error");const e={};e[t.property]=t.to,null!=t.start&&null!=t.start&&(t.shape.props[t.property]=t.start),this.action.push(new W(t.shape.props).to(e,t.duration).delay(t.delay))}removeAnimate(t){const e=this.action.findIndex((e=>e.getId()==t));-1!=e&&this.action.splice(e,1)}start(){1!=this.state&&this.action.length&&(this.state=1,this.action.forEach(((t,e)=>{e!==this.action.length-1&&t.onComplete((()=>{this.action[e+1].start()}))})),this.action[this.action.length-1].onComplete((()=>{this.state=0})),this.action[0].start())}setName(t){this.name=t}}class tt extends u{animateType="";imageDate;show=!1;constructor(t,e){super(),this.animateType=e,this.imageDate=t}customDraw(t){return!1}draw(t,e){if(!this.show)return;const{x:s,y:i}=this.props;t.save(),this.transform(t),this.initOptions(t,1),this.customDraw(t)||t.drawImage(this.imageDate,s,i),t.restore()}}return{drawiBoardBagua:D,Rect:v,Arc:f,Arrow:m,Group:y,Triangle:b,Pentagram:g,PPTControl:class{tabs=[];shapes=[];tabIndex=0;curIndex=0;canvas;width=800;height=600;ctx;canvasPre;constructor(t,e){e&&(this.width=e.width||300,this.height=e.height||250),this.canvas=t,this.canvas.width=this.width,this.canvas.height=this.height,this.canvasPre=document.createElement("canvas"),this.canvasPre.width=this.width,this.canvasPre.height=this.height,this.canvasPre.id="bagua",this.ctx=this.canvasPre.getContext("2d"),this.init(),this.animate()}addTab(){this.tabs.push(new Q(this.canvas,{width:this.width,height:this.height}))}removeTabByIndex(t){this.tabs.splice(t,1)}init(){const t=["","louver","shape","incision","fade","push-in","push-aside"];for(let e=0;e<t.length;e++){const s=new Q(this.canvas,{width:this.width,height:this.height});s.animateType=t[e],s.import(JSON.parse('{"width":800,"height":500,"shapes":[{"id":"106-32-184-255","type":"other","props":{"id":"106-32-184-255","width":0,"height":0,"x":0,"y":0,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[]}},{"id":"49-14-22-255","type":"Rect","props":{"id":"49-14-22-255","width":100,"height":200,"x":200,"y":200,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[]}},{"id":"74-94-161-255","type":"Triangle","props":{"id":"74-94-161-255","width":200,"height":200,"x":200,"y":300,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[]}},{"id":"53-156-19-255","type":"Arrow","props":{"id":"53-156-19-255","width":200,"height":50,"x":200,"y":400,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[]}},{"id":"152-97-149-255","type":"Arc","props":{"id":"152-97-149-255","width":100,"height":100,"x":400,"y":400,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":50,"isGroup":false,"shapes":[]}},{"id":"242-39-91-255","type":"Pentagram","props":{"id":"242-39-91-255","width":100,"height":100,"x":500,"y":500,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":50,"isGroup":false,"shapes":[]}},{"id":"149-210-110-255","type":"Group","props":{"id":"149-210-110-255","width":300,"height":300,"x":450,"y":200,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[{"id":"136-92-110-255","listeners":{},"type":"Arrow","props":{"id":"136-92-110-255","width":200,"height":50,"x":250,"y":100,"bgcolor":"red","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":5,"isGroup":false,"shapes":[]},"actived":false},{"id":"79-53-177-255","listeners":{},"type":"Arc","props":{"id":"79-53-177-255","width":100,"height":100,"x":200,"y":200,"bgcolor":"blue","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":50,"isGroup":false,"shapes":[]},"actived":false},{"id":"182-16-190-255","listeners":{},"type":"Pentagram","props":{"id":"182-16-190-255","width":100,"height":100,"x":50,"y":50,"bgcolor":"black","borderWidth":1,"borderColor":"black","fontSize":"12px","textColor":"black","text":"","scaleX":1,"scaleY":1,"rotation":0,"size":10,"textList":[],"lineHeight":0,"lineWidth":0,"lateX":0,"lateY":0,"radius":50,"isGroup":false,"shapes":[]},"actived":false}]}}]}')),s.count=e+1,this.tabs.push(s)}this.preview()}preview(){const t=document.createElement("canvas");t.width=this.width,t.height=this.height;let e=t.getContext("2d");if(!e)return;this.shapes.push(...this.tabs.map((s=>new tt(s.snapshot(e,t),s.animateType))));const{width:s,height:i}=this,o=2e3,r=[];let a=null;for(let t=0;t<this.shapes.length;t++){const e=this.shapes[t],n=new W(e.props);switch(e.animateType){case"":e.props.y=i,n.to({y:0},o).onStart((()=>{e.show=!0}));break;case"smooth":case"fade":e.props.opacity=0,n.to({opacity:1},o).onStart((()=>{e.show=!0}));break;case"push-in":e.props.x=s,n.to({x:0},o).onUpdate(((i,o)=>{e.props.x=i.x,0!=t&&(this.shapes[t-1].props.x=i.x-s)})).onStart((()=>{e.show=!0,0!=t&&(this.shapes[t-1].show=!0)}));break;case"push-aside":e.props.y=i,n.to({y:0},o).onUpdate((s=>{e.props.y=s.y,0!=t&&(this.shapes[t-1].props.lateY=s.y-i)})).onStart((()=>{e.show=!0,0!=t&&(this.shapes[t-1].show=!0)}));break;case"erase":case"incision":this.qieke(e,n,o);break;case"cut-in":case"louver":this.qiekeq1(e,n,o);break;case"shape":const r={r:0,dr:Math.sqrt(s*s+i*i)/2};e.props.x=s/2,e.props.y=i/2,e.customDraw=o=>(0!=t&&o.drawImage(this.shapes[t-1].imageDate,e.props.x-s/2,e.props.y-i/2),o.save(),o.beginPath(),o.arc(e.props.x,e.props.y,r.r,0,2*Math.PI,!0),o.stroke(),o.clip(),o.clearRect(0,0,s,i),o.drawImage(e.imageDate,e.props.x-s/2,e.props.y-i/2),o.closePath(),o.restore(),!0),e.props.opacity=1,n.to({opacity:0},o).onStart((()=>{e.show=!0})).onUpdate(((t,s)=>{e.props.opacity=1,r.r=s*r.dr}))}0===t&&(a=n),r.push({move:n,shape:e})}r.forEach(((t,e)=>{e!==r.length-1?t.move.onComplete((()=>{t.shape.show=!1,r[e-1]&&(r[e-1].shape.show=!1),r[e+1].move.start()})):t.move.onComplete((()=>{r[e-1]&&(r[e-1].shape.show=!1)}))})),a&&a.start()}qieke(t,e,s){const i=this.width/2,o=this.width/2,r=[];for(let e=0;e<2;e++)r.push({x:i*e+t.props.x,y:0,w:i,h:this.height,dx:i*e,dy:0,dw:i,dh:this.height,lateX:i*e+t.props.x,lateY:0,lateW:i,lateH:this.height});t.customDraw=e=>{for(let s=0;s<2;s++){const i=r[s];e.drawImage(t.imageDate,i.dx,i.dy,i.dw,i.dh,i.x,i.y,i.w,i.h)}return!0},t.props.opacity=1,e.to({opacity:0},s/2).onStart((()=>{t.show=!0})).onUpdate(((e,s)=>{t.props.opacity=1;for(let t=0;t<r.length;t++)t<r.length/2?r[t].x=-o*s+r[t].lateX:r[t].x=o*s+r[t].lateX}))}qiekeq1(t,e,s){const i=this.width/50,o=[];for(let t=0;t<50;t++)o.push({x:i*t,y:0,w:i,h:this.height,dx:i*t,dy:0,dw:i,dh:this.height,lateX:i*t,lateY:0,lateW:i,lateH:this.height});t.customDraw=e=>{for(let s=0;s<50;s++){const i=o[s];e.drawImage(t.imageDate,i.dx,i.dy,i.dw,i.dh,i.x,i.y,i.w,i.h)}return!0},t.props.opacity=1,e.to({opacity:0},s/2).onStart((()=>{t.show=!0})).onUpdate(((e,s)=>{t.props.opacity=1;for(let t=0;t<o.length;t++)o[t].w=o[t].lateW-o[t].lateW*s}))}render(){if(this.ctx){this.ctx.clearRect(0,0,this.width,this.height);for(let t=this.shapes.length-1;t>=0;t--)this.shapes[t].draw(this.ctx,this.ctx)}}animate(){J.update(),this.render(),window.requestAnimationFrame(this.animate.bind(this))}get domElement(){return this.canvas}}}}));
//# sourceMappingURL=two.js.map
